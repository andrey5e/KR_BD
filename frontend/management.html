<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Drive/–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
    <style nonce="abc123">
        :root {
            --bg-color: #fefff5;
            --text-color: #000;
            --nav-bg: #ccc;
            --nav-hover: #a50000;
            --li-bg: #f9f9f9;
            --modal-bg: #fefefe;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body { 
            font-family: Arial, sans-serif; 
            margin: 35px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark {
            --bg-color: #333;
            --text-color: #fff;
            --nav-bg: #555;
            --nav-hover: #a50000;
            --li-bg: #444;
            --modal-bg: #444;
            --shadow: rgba(255,255,255,0.1);
        }
        
        nav { margin-bottom: 20px; text-align: center; }
        nav a { text-decoration: none; padding: 10px; background: var(--nav-bg); color: var(--text-color); margin: 5px; border-radius: 5px; transition: background 0.3s; }
        nav a.active { background: var(--nav-hover); color: white; }
        nav a:hover { background: var(--nav-hover); }
        .tabs { display: flex; margin-top: 20px; margin-bottom: 0px; flex-wrap: wrap; }
        .tab { text-decoration: none; padding: 10px; background: var(--nav-bg); color: var(--text-color); margin: 5px; display: inline-block; border-radius: 5px 5px 0 0; cursor: pointer; transition: background 0.3s; }
        .tab.active { background: var(--nav-hover); color: white; }
        .tab:hover { background: var(--nav-hover); }
        .tab-content { display: none; padding: 10px; background: var(--li-bg); border-radius: 5px; box-shadow: 0 2px 4px var(--shadow); }
        .tab-content.active { display: block; }
        h2, h3 { font-size: 1.5em; color: var(--text-color);}
        h2.centered { text-align: center; }

        button { padding: 10px 15px; background: var(--nav-hover); color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; transition: background 0.3s; }
        button:hover { background: #a4a4a4; color: #333; }
        button.danger { background: #a50000; }
        button.danger:hover { background: #a50000; }
        ul { list-style: none; padding: 0; }
        li { background: var(--li-bg); margin: 10px 0; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: var(--modal-bg); margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; color: var(--text-color); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        form { display: flex; flex-direction: column; }
        input, select, textarea { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background: var(--li-bg); color: var(--text-color); }
        input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; }
        textarea { resize: vertical; }
        .contract-details { font-size: 0.9em; color: #665; }
        
        #theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--nav-bg);
            color: var(--text-color);
            border: none;
            padding: 10px 10px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background 0.3s;
            box-shadow: 0 4px 8px var(--shadow);
            z-index: 10;
        }
        #theme-toggle:hover {
            background: var(--nav-hover);
            color: white;
        }
    </style>
</head>
<body>
    <button id="theme-toggle">‚òÄÔ∏è</button>
    
    <nav>
        <a href="autopark.html">–ê–≤—Ç–æ–ø–∞—Ä–∫</a>
        <a href="select.html">–í—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ</a>
        <a href="management.html" class="active">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a>
        <a href="main.html">–í—ã—Ö–æ–¥</a>
    </nav>
    
    <div class="tabs">
        <div class="tab active" data-tab="clients">–ö–ª–∏–µ–Ω—Ç—ã</div>
        <div class="tab" data-tab="contracts">–î–æ–≥–æ–≤–æ—Ä—ã</div>
        <div class="tab" data-tab="insurances">–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ</div>
        <div class="tab" data-tab="maintenances">–¢–µ—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
    </div>

    <div id="clients" class="tab-content active">
        <h2 class="centered">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h2>
        <button id="addClientBtn">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
        <h3>–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
        <ul id="clientList"></ul>
    </div>

    <div id="contracts" class="tab-content">
        <h2 class="centered">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏</h2>
        <button id="addContractBtn">–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä</button>
        <h3>–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ã</h3>
        <ul id="activeContracts"></ul>
        <h3>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã</h3>
        <ul id="completedContracts"></ul>
    </div>

    <div id="insurances" class="tab-content">
        <h2 class="centered">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ–º</h2>
        <button id="addInsuranceBtn">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É</button>
        <h3>–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫</h3>
        <ul id="insuranceList"></ul>
    </div>

    <div id="maintenances" class="tab-content">
        <h2 class="centered">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ–º</h2>
        <button id="addMaintenanceBtn">–î–æ–±–∞–≤–∏—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</button>
        <h3>–°–ø–∏—Å–æ–∫ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–π</h3>
        <ul id="maintenanceList"></ul>
    </div>

    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeClientModal">&times;</span>
            <h2 id="clientModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h2>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <label for="fullName">–§–ò–û:</label>
                <input type="text" id="fullName" required>
                <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="tel" id="phone" required>
                <label for="license">–ù–æ–º–µ—Ä –í–£:</label>
                <input type="text" id="license" required>
                <label for="birthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
                <input type="date" id="birthDate" required max="2005-12-31">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="contractModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeContractModal">&times;</span>
            <h2>–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä</h2>
            <form id="contractForm">
                <label for="clientSelect">–ö–ª–∏–µ–Ω—Ç (–§–ò–û):</label>
                <select id="clientSelect" required></select>
                <label for="carSelect">–ê–≤—Ç–æ (–ì–æ—Å –Ω–æ–º–µ—Ä):</label>
                <select id="carSelect" required></select>
                <label for="startDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                <input type="date" id="startDate" required>
                <label for="endDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                <input type="date" id="endDate" required>
                <label for="paymentDate">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞:</label>
                <input type="date" id="paymentDate" required>
                <label for="amount">–°—É–º–º–∞ (—Ä—É–±.):</label>
                <input type="text" id="amount" pattern="[0-9\s]*" minlength="1" required placeholder="–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)">
                <button type="submit">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="insuranceModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeInsuranceModal">&times;</span>
            <h2 id="insuranceModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É</h2>
            <form id="insuranceForm">
                <input type="hidden" id="insuranceId">
                <label for="contractSelect">–î–æ–≥–æ–≤–æ—Ä:</label>
                <select id="contractSelect" required></select>
                <label for="insuranceCost">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.):</label>
                <input type="text" id="insuranceCost" pattern="[0-9\s]*" minlength="1" required placeholder="70% –æ—Ç —Å—É–º–º—ã –∞—Ä–µ–Ω–¥—ã">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="maintenanceModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeMaintenanceModal">&times;</span>
            <h2 id="maintenanceModalTitle">–î–æ–±–∞–≤–∏—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h2>
            <form id="maintenanceForm">
                <input type="hidden" id="maintenanceId">
                <label for="carSelectMaintenance">–ê–≤—Ç–æ (–ì–æ—Å –Ω–æ–º–µ—Ä):</label>
                <select id="carSelectMaintenance" required></select>
                <label for="maintenanceDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="maintenanceDescription" required></textarea>
                <label for="maintenanceDate">–î–∞—Ç–∞:</label>
                <input type="date" id="maintenanceDate" required>
                <label for="maintenanceCost">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.):</label>
                <input type="number" id="maintenanceCost" step="0.01" required>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>
    
    <script nonce="abc123">
        const apiUrl = 'http://127.0.0.1:8000';

        function applyTheme(theme) {
            const body = document.body;
            const toggleBtn = document.getElementById('theme-toggle');
            if (theme === 'dark') {
                body.classList.add('dark');
                toggleBtn.textContent = 'üåô';
            } else {
                body.classList.remove('dark');
                toggleBtn.textContent = '‚òÄÔ∏è';
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(tab).classList.add('active');
            if (tab === 'clients') loadClients();
            else if (tab === 'contracts') { loadClientsForSelect(); loadCarsForSelect(); loadContracts(); }
            else if (tab === 'insurances') { loadContractsForSelect(); loadInsurances(); }
            else if (tab === 'maintenances') { loadCarsForSelectMaintenance(); loadMaintenances(); }
        }

        async function loadClients() {
            try {
                const response = await fetch(`${apiUrl}/clients`);
                const clients = await response.json();
                const list = document.getElementById('clientList');
                list.innerHTML = '';
                clients.forEach(client => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>${client.full_name}</strong><br>
                            –¢–µ–ª: ${client.phone}<br>
                            –í–£: ${client.license_number}<br>
                            –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${client.birth_date}
                        </div>
                        <div>
                            <button class="editClientBtn" data-id="${client.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="deleteClientBtn danger" data-id="${client.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
                document.querySelectorAll('.editClientBtn').forEach(btn => {
                    btn.addEventListener('click', () => editClient(btn.getAttribute('data-id')));
                });
                document.querySelectorAll('.deleteClientBtn').forEach(btn => {
                    btn.addEventListener('click', () => deleteClient(btn.getAttribute('data-id')));
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        }

        function editClient(id) {
            openClientModal(id);
        }

        function openClientModal(id = null) {
            document.getElementById('clientModal').style.display = 'block';
            if (id) {
                document.getElementById('clientModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞';
                fetch(`${apiUrl}/clients/${id}`)
                    .then(r => r.json())
                    .then(client => {
                        document.getElementById('clientId').value = client.id;
                        document.getElementById('fullName').value = client.full_name;
                        const phoneDigits = client.phone.replace(/\D/g, '');
                        document.getElementById('phone').value = '+7' + phoneDigits;
                        document.getElementById('license').value = client.license_number;
                        document.getElementById('birthDate').value = client.birth_date;
                    })
                    .catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:', err);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.');
                    });
            } else {
                document.getElementById('clientModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞';
                document.getElementById('clientForm').reset();
                document.getElementById('phone').value = '+7';
            }
        }
        
        document.getElementById('closeClientModal').addEventListener('click', () => closeClientModal());
        
        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }
        
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('clientId').value;
            const data = {
                full_name: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                license_number: document.getElementById('license').value,
                birth_date: document.getElementById('birthDate').value
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${apiUrl}/clients/${id}` : `${apiUrl}/clients`;
            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) {
                    closeClientModal();
                    loadClients();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + response.status);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        });
        
        async function deleteClient(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?')) {
                try {
                    await fetch(`${apiUrl}/clients/${id}`, { method: 'DELETE' });
                    loadClients();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞.');
                }
            }
        }

        async function loadClientsForSelect() {
            try {
                const response = await fetch(`${apiUrl}/clients`);
                const clients = await response.json();
                const select = document.getElementById('clientSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.full_name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞.');
            }
        }

        async function loadCarsForSelect() {
            try {
                const response = await fetch(`${apiUrl}/available-cars`);
                const cars = await response.json();
                const select = document.getElementById('carSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
                cars.forEach(car => {
                    const option = document.createElement('option');
                    option.value = car.id;
                    option.setAttribute('data-price', car.price);
                    option.textContent = `${car.brand} ${car.model} (${car.license_plate})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞.');
            }
        }

        async function loadContracts() {
            try {
                const response = await fetch(`${apiUrl}/contracts`);
                const contracts = await response.json();
                const activeList = document.getElementById('activeContracts');
                const completedList = document.getElementById('completedContracts');
                activeList.innerHTML = '';
                completedList.innerHTML = '';
                contracts.forEach(contract => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>–î–æ–≥–æ–≤–æ—Ä #${contract.id}</strong><br>
                            –ö–ª–∏–µ–Ω—Ç: ${contract.client.full_name}<br>
                            –ê–≤—Ç–æ: ${contract.car.brand} ${contract.car.model} (${contract.car.license_plate})<br>
                            –ü–µ—Ä–∏–æ–¥: ${contract.start_date} - ${contract.end_date}<br>
                            –°—É–º–º–∞: ${contract.amount} —Ä—É–±.<br>
                            <span class="contract-details">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞: ${contract.payment_date}</span>
                        </div>
                        <div>
                            ${contract.status === 'active' ? '<button class="completeContractBtn" data-id="' + contract.id + '">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>' : '<button class="deleteContractBtn danger" data-id="' + contract.id + '">–£–¥–∞–ª–∏—Ç—å</button>'}
                        </div>
                    `;
                    if (contract.status === 'active') {
                        activeList.appendChild(li);
                    } else {
                        completedList.appendChild(li);
                    }
                });
                document.querySelectorAll('.completeContractBtn').forEach(btn => {
                    btn.addEventListener('click', () => completeContract(btn.getAttribute('data-id')));
                });
                document.querySelectorAll('.deleteContractBtn').forEach(btn => {
                    btn.addEventListener('click', () => deleteContract(btn.getAttribute('data-id')));
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–æ–≤:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        }

        async function completeContract(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–≥–æ–≤–æ—Ä?')) {
                try {
                    const response = await fetch(`${apiUrl}/contracts/${id}/complete`, { method: 'PUT' });
                    if (response.ok) {
                        loadContracts();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞: ' + response.status);
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä.');
                }
            }
        }

        async function deleteContract(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä?')) {
                try {
                    await fetch(`${apiUrl}/contracts/${id}`, { method: 'DELETE' });
                    loadContracts();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä.');
                }
            }
        }

        function calculateAmount() {
            const carSelect = document.getElementById('carSelect');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const amountInput = document.getElementById('amount');

            if (!carSelect.value || !startDate || !endDate) {
                amountInput.value = '';
                return;
            }

            const selectedOption = carSelect.options[carSelect.selectedIndex];
            const pricePerDay = parseInt(selectedOption.getAttribute('data-price'), 10);
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end <= start) {
                amountInput.value = '';
                return;
            }
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            const totalAmount = pricePerDay * days;
            amountInput.value = formatAmount(totalAmount.toString());
        }

        document.getElementById('addClientBtn').addEventListener('click', () => openClientModal());
        document.getElementById('addContractBtn').addEventListener('click', () => {
            document.getElementById('contractModal').style.display = 'block';
        });
        document.getElementById('closeContractModal').addEventListener('click', () => {
            document.getElementById('contractModal').style.display = 'none';
        });

        document.getElementById('contractForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (new Date(endDate) <= new Date(startDate)) {
                alert('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞!');
                return;
            }
            const data = {
                client_id: document.getElementById('clientSelect').value,
                car_id: document.getElementById('carSelect').value,
                start_date: startDate,
                end_date: endDate,
                payment_date: document.getElementById('paymentDate').value,
                amount: parseFloat(document.getElementById('amount').value.replace(/\s/g, ''))
            };
            try {
                const response = await fetch(`${apiUrl}/contracts`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) {
                    document.getElementById('contractModal').style.display = 'none';
                    document.getElementById('contractForm').reset();
                    loadContracts();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞: ' + response.status);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        });

        async function loadContractsForSelect() {
            try {
                const response = await fetch(`${apiUrl}/contracts`);
                const contracts = await response.json();
                const select = document.getElementById('contractSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option>';
                contracts.forEach(contract => {
                    const option = document.createElement('option');
                    option.value = contract.id;
                    option.setAttribute('data-daily-price', contract.car.price);
                    option.setAttribute('data-start-date', contract.start_date);
                    option.setAttribute('data-end-date', contract.end_date);
                    option.textContent = `–î–æ–≥–æ–≤–æ—Ä #${contract.id} (${contract.client.full_name} - ${contract.car.brand} ${contract.car.model})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞.');
            }
        }

        function calculateInsuranceCost() {
            const contractSelect = document.getElementById('contractSelect');
            const insuranceCostInput = document.getElementById('insuranceCost');

            if (!contractSelect.value) {
                insuranceCostInput.value = '';
                return;
            }

            const selectedOption = contractSelect.options[contractSelect.selectedIndex];
            const dailyPrice = parseInt(selectedOption.getAttribute('data-daily-price'), 10);
            const startDate = selectedOption.getAttribute('data-start-date');
            const endDate = selectedOption.getAttribute('data-end-date');

            if (!startDate || !endDate) {
                insuranceCostInput.value = '';
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end <= start) {
                insuranceCostInput.value = '';
                return;
            }

            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            const totalRental = dailyPrice * days;
            const insuranceCost = 0.7 * totalRental;
            insuranceCostInput.value = formatAmount(insuranceCost.toString());
        }

        async function loadInsurances() {
            try {
                const response = await fetch(`${apiUrl}/insurances`);
                const insurances = await response.json();
                const list = document.getElementById('insuranceList');
                list.innerHTML = '';
                insurances.forEach(insurance => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ #${insurance.id}</strong><br>
                            –ö–ª–∏–µ–Ω—Ç: ${insurance.contract.client.full_name}<br>
                            –ê–≤—Ç–æ: ${insurance.contract.car.brand} ${insurance.contract.car.model} (${insurance.contract.car.license_plate})<br>
                            –°—Ç–æ–∏–º–æ—Å—Ç—å: ${insurance.cost} —Ä—É–±.
                        </div>
                        <div>
                            <button class="deleteInsuranceBtn danger" data-id="${insurance.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
                document.querySelectorAll('.deleteInsuranceBtn').forEach(btn => {
                    btn.addEventListener('click', () => deleteInsurance(btn.getAttribute('data-id')));
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        }

        function openInsuranceModal(id = null) {
            document.getElementById('insuranceModal').style.display = 'block';
            document.getElementById('insuranceModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É';
            document.getElementById('insuranceForm').reset();
            document.getElementById('insuranceCost').value = '';
        }
        
        document.getElementById('closeInsuranceModal').addEventListener('click', () => closeInsuranceModal());
        
        function closeInsuranceModal() {
            document.getElementById('insuranceModal').style.display = 'none';
        }
        
        document.getElementById('insuranceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                contract_id: document.getElementById('contractSelect').value,
                cost: parseFloat(document.getElementById('insuranceCost').value.replace(/\s/g, ''))
            };
            try {
                const response = await fetch(`${apiUrl}/insurances`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) {
                    closeInsuranceModal();
                    loadInsurances();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏: ' + response.status);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        });
        
        async function deleteInsurance(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–∞—Ö–æ–≤–∫—É?')) {
                try {
                    await fetch(`${apiUrl}/insurances/${id}`, { method: 'DELETE' });
                    loadInsurances();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É.');
                }
            }
        }
        
        async function deleteInsurance(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–∞—Ö–æ–≤–∫—É?')) {
                try {
                    await fetch(`${apiUrl}/insurances/${id}`, { method: 'DELETE' });
                    loadInsurances();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É.');
                }
            }
        }

        function openInsuranceModal(id = null) {
            document.getElementById('insuranceModal').style.display = 'block';
            document.getElementById('insuranceModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É';
            document.getElementById('insuranceForm').reset();
            document.getElementById('insuranceCost').value = '';
        }
        
        document.getElementById('closeInsuranceModal').addEventListener('click', () => closeInsuranceModal());
        
        function closeInsuranceModal() {
            document.getElementById('insuranceModal').style.display = 'none';
        }
        
        document.getElementById('insuranceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                contract_id: document.getElementById('contractSelect').value,
                cost: parseFloat(document.getElementById('insuranceCost').value.replace(/\s/g, ''))
            };
            try {
                const response = await fetch(`${apiUrl}/insurances`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) {
                    closeInsuranceModal();
                    loadInsurances();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏: ' + response.status);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        });
        
        async function deleteInsurance(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–∞—Ö–æ–≤–∫—É?')) {
                try {
                    await fetch(`${apiUrl}/insurances/${id}`, { method: 'DELETE' });
                    loadInsurances();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É.');
                }
            }
        }

        async function loadCarsForSelectMaintenance() {
            try {
                const response = await fetch(`${apiUrl}/cars`);
                const cars = await response.json();
                const select = document.getElementById('carSelectMaintenance');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
                cars.forEach(car => {
                    const option = document.createElement('option');
                    option.value = car.id;
                    option.textContent = `${car.brand} ${car.model} (${car.license_plate})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.');
            }
        }

        async function loadMaintenances() {
            try {
                const response = await fetch(`${apiUrl}/maintenances`);
                const maintenances = await response.json();
                const list = document.getElementById('maintenanceList');
                list.innerHTML = '';
                maintenances.forEach(maintenance => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ #${maintenance.id}</strong><br>
                            –ê–≤—Ç–æ: ${maintenance.car.brand} ${maintenance.car.model} (${maintenance.car.license_plate})<br>
                            –û–ø–∏—Å–∞–Ω–∏–µ: ${maintenance.description}<br>
                            –î–∞—Ç–∞: ${maintenance.date}<br>
                            –°—Ç–æ–∏–º–æ—Å—Ç—å: ${maintenance.cost} —Ä—É–±.
                        </div>
                        <div>
                            <button class="deleteMaintenanceBtn danger" data-id="${maintenance.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
                document.querySelectorAll('.deleteMaintenanceBtn').forEach(btn => {
                    btn.addEventListener('click', () => deleteMaintenance(btn.getAttribute('data-id')));
                });
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–π:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        }

        function openMaintenanceModal(id = null) {
            document.getElementById('maintenanceModal').style.display = 'block';
            document.getElementById('maintenanceModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            document.getElementById('maintenanceForm').reset();
        }
        
        document.getElementById('closeMaintenanceModal').addEventListener('click', () => closeMaintenanceModal());
        
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').style.display = 'none';
        }
        
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                car_id: document.getElementById('carSelectMaintenance').value,
                description: document.getElementById('maintenanceDescription').value,
                date: document.getElementById('maintenanceDate').value,
                cost: parseFloat(document.getElementById('maintenanceCost').value)
            };
            try {
                const response = await fetch(`${apiUrl}/maintenances`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) {
                    closeMaintenanceModal();
                    loadMaintenances();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è: ' + response.status);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.');
            }
        });
        
        async function deleteMaintenance(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ?')) {
                try {
                    await fetch(`${apiUrl}/maintenances/${id}`, { method: 'DELETE' });
                    loadMaintenances();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.');
                }
            }
        }

        document.getElementById('addInsuranceBtn').addEventListener('click', () => openInsuranceModal());
        document.getElementById('addMaintenanceBtn').addEventListener('click', () => openMaintenanceModal());

        function formatPhone(value) {
            if (!value.startsWith('+7')) {
                value = '+7' + value.replace(/\D/g, '');
            }

            const afterPlus7 = value.substring(2).replace(/\D/g, '');
            const digits = afterPlus7.slice(0, 10);
            let formatted = '+7';
            if (digits.length >= 1) formatted += ' (' + digits.slice(0, 3);
            if (digits.length >= 4) formatted += ') ' + digits.slice(3, 6);
            if (digits.length >= 7) formatted += '-' + digits.slice(6, 8);
            if (digits.length >= 9) formatted += '-' + digits.slice(8, 10);
            return formatted;
        }

        function formatLicense(value) {
            const digits = value.replace(/\D/g, '');
            const limitedDigits = digits.slice(0, 10);
            let formatted = '';
            if (limitedDigits.length > 0) formatted += limitedDigits.slice(0, 2);
            if (limitedDigits.length > 2) formatted += ' ' + limitedDigits.slice(2, 4);
            if (limitedDigits.length > 4) formatted += ' ' + limitedDigits.slice(4, 10);
            return formatted;
        }

        function formatAmount(value) {
            const digits = value.replace(/\D/g, '');
            return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('phone').addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const formatted = formatPhone(e.target.value);
                e.target.value = formatted;
                setTimeout(() => e.target.setSelectionRange(cursorPos, cursorPos), 0);
            });

            document.getElementById('license').addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const formatted = formatLicense(e.target.value);
                e.target.value = formatted;
                setTimeout(() => e.target.setSelectionRange(cursorPos, cursorPos), 0);
            });

            document.getElementById('amount').addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const formatted = formatAmount(e.target.value);
                e.target.value = formatted;
                setTimeout(() => e.target.setSelectionRange(cursorPos, cursorPos), 0);
            });


